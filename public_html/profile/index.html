<!DOCTYPE html>
<html>
<head>
  <title>Profile Page</title>
</head>
<body>
  <div data-navbar></div>
  <center>
    <h1>Profile Page</h1>
    Hello!
    <div id="profile_content"></div>
    <div id="change_status">
      <p>I am <span id="status_display"></span></p>
      <p>
        <select id="status_select">
          <option value="HEALTHY">Healthy</option>
          <option value="SYMPTOMATIC">Symptomatic</option>
          <option value="INFECTED">Infected</option>
          <option value="RECOVERING">Recovering</option>
          <option value="HEALTHY-IMMUNE">Healthy & Immune</option>
        </select>
        <input type="button" id="update_status" value="Update Status">
      </p>
    </div>
    <div>
      Change Password:
      <form id="change_password">
        <label>New Password: <input type="password" id="password" required></label><br>
        <label>Reenter New Password: <input type="password" id="reenter_password" required></label><br>
        <input type="submit" value="Change Password">
      </form>
      <p id="password_change_feedback"></p>
    </div>
  </center>
  <script src="/navbar.js"></script>
  <script type="text/javascript">
    var $ = document.querySelector.bind(document);

    var displayStatus = {
        "HEALTHY": "Healthy",
        "SYMPTOMATIC": "Symptomatic",
        "INFECTED": "Infected",
        "RECOVERING": "Recovering",
        "HEALTHY-IMMUNE": "Healthy & Immune"
    };

    (async () => {
      let response = await (await fetch("/api/getsession", {method: "POST"})).json();
      $("#profile_content").innerHTML = `
        <p>Your username is '${response.username}'</p>
        <p>Your email address is ${response.email}</p>
      `;
      $("#status_display").innerHTML = displayStatus[response.status];
    })();

    $("#change_password").onsubmit = async e => {
      e.preventDefault(true);
      if ($("#password").value !== $("#reenter_password").value) {
        $("#password_change_feedback").innerHTML = "Passwords do not match!";
      } else {
        let sessiondata = await (await fetch("/api/getsession", {method: "POST"})).json();
        if (!sessiondata.success) {
          $("#password_change_feedback").innerHTML = "Invalid session; please log back in";
        } else {
          let response = await (await fetch("/api/changepassword", {
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              userid: sessiondata.userid,
              newPassword: $("#password").value
            })
          })).json()
          $("#password_change_feedback").innerHTML = response.message;
        }
      }
    };

    $("#update_status").onclick = async () => {
      let sessiondata = await (await fetch("/api/getsession", {method: "POST"})).json();
      if (!sessiondata.success) {
        $("#password_change_feedback").innerHTML = "Invalid session; please log back in";
      } else {
        let select = $("#status_select");
        let response = await (await fetch("/api/updatestatus", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userid: sessiondata.userid,
            status: select.options[select.selectedIndex].value
          })
        })).json();
        if (response.success) {
          console.log(response);
          $("#status_display").innerHTML = displayStatus[select.options[select.selectedIndex].value];
        } else {
          $("#password_change_feedback").innerHTML = response.message;
        }
      }
    };
  </script>
</body>
</html>