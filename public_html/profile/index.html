<!DOCTYPE html>
<html>
<head>
  <title>Profile Page</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>
  <div data-navbar></div>
  <center>
    <h1>Profile Page</h1>
    Hello!
    <div id="profile_content"></div>
    <div id="change_status">
      <p>I am <span id="status_display"></span></p>
      <p>
        <select id="status_select">
          <option value="HEALTHY">Healthy</option>
          <option value="SYMPTOMATIC">Symptomatic</option>
          <option value="INFECTED">Infected</option>
          <option value="RECOVERING">Recovering</option>
          <option value="HEALTHY-IMMUNE">Healthy & Immune</option>
        </select>
        <input type="button" id="update_status" value="Update Status">
      </p>
    </div>
    <div>
      Change Password:
      <form id="change_password">
        <label>New Password: <input type="password" id="password" required></label><br>
        <label>Reenter New Password: <input type="password" id="reenter_password" required></label><br>
        <input type="submit" value="Change Password">
      </form>
      <p id="password_change_feedback"></p>
    </div>
  </center>
  <div id="visit_list"></div>
  <script src="/navbar.js"></script>
  <script type="text/javascript">
    var $ = document.querySelector.bind(document);

    var displayStatus = {
        "HEALTHY": "Healthy",
        "SYMPTOMATIC": "Symptomatic",
        "INFECTED": "Infected",
        "RECOVERING": "Recovering",
        "HEALTHY-IMMUNE": "Healthy & Immune"
    };

    fetch("/api/getsession", {
      method: "POST"
    }).then(async response => {
      response = await response.json();

      $("#profile_content").innerHTML = `
        <p>Your username is '${response.session.user.username}'</p>
        <p>Your email address is ${response.session.user.email}</p>`;

      $("#status_display").innerHTML = displayStatus[response.session.user.status];
    });

    fetch("/api/contagiousvisits", {
      method: "POST"
    }).then(async response => {
      response = await response.json();

      if (response.success) {
        let visitHtml = `
          <ul>`;
        for (var visit of response.visits) {
          let userlist = visit.contacts.map(c => c.username).join(", ");
          visitHtml += `
            <li> 
              Contacts at ${visit.name} on ${new Date(visit.time * 1000).toLocaleString()}
              <ul>`;
          for (let contact of visit.contacts) {
            visitHtml += `
                <li> 
                  ${contact.username} at ${new Date(contact.time * 1000).toLocaleString()}, Infection risk: ${contact.contagionRisk}
                </li>`;
          }
          visitHtml += `
              </ul>
            </li>`;
        }
        visitHtml += `
          </ul>`;
        visitHtml += `
          <p>
            Overall risk of infection: ${response.overallRisk}
          </p>`;

        $("#visit_list").innerHTML = visitHtml;
      }
    });

    $("#change_password").onsubmit = async e => {
      e.preventDefault(true);
      if ($("#password").value !== $("#reenter_password").value) {
        $("#password_change_feedback").innerHTML = "Passwords do not match!";
      } else {
        let response = await (await fetch("/api/getsession", {method: "POST"})).json();
        let session = response.session;
        if (session.type === "User") {
          response = await (await fetch("/api/changepassword", {
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              newPassword: $("#password").value
            })
          })).json();
          $("#password_change_feedback").innerHTML = response.message
        } else if (session.type === "Anonymous") {
          $("#password_change_feedback").innerHTML = "Invalid session; please log back in";
        }
      }
    };

    $("#update_status").onclick = async () => {
      let response = await (await fetch("/api/getsession", {method: "POST"})).json();
      let session = response.session;
      if (session.type === "User") {
        let select = $("#status_select");
        let response = await (await fetch("/api/updatestatus", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: select.options[select.selectedIndex].value
          })
        })).json();
        if (response.success) {
          $("#status_display").innerHTML = displayStatus[select.options[select.selectedIndex].value];
        }
      } else if (session.type === "Anonymous")  {
        $("#password_change_feedback").innerHTML = "Invalid session; please log back in";
      }
    }
  </script>
</body>
</html>